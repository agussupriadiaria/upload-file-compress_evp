<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload & Compress Foto dan Video</title>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@latest/dist/browser-image-compression.js"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    video, img { margin: 10px 0; display: block; }
    hr { margin: 20px 0; }
  </style>
</head>
<body>
  <h2>Upload & Compress</h2>
  <input type="file" id="fileInput" multiple accept="image/*,video/*" />
  <div id="output"></div>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    document.getElementById('fileInput').addEventListener('change', async (event) => {
      const files = event.target.files;
      const outputDiv = document.getElementById('output');
      outputDiv.innerHTML = '‚è≥ Processing files...<br>';

      for (let file of files) {
        const fileType = file.type;
        outputDiv.innerHTML += `<p>üîÑ Processing: ${file.name}</p>`;

        if (fileType.startsWith('image/')) {
          // KOMPREST GAMBAR
          try {
            const options = {
              maxSizeMB: 1,
              maxWidthOrHeight: 1280,
              useWebWorker: true
            };
            const compressedFile = await imageCompression(file, options);
            const url = URL.createObjectURL(compressedFile);

            outputDiv.innerHTML += `<p>‚úÖ Gambar dikompres: ${compressedFile.name} - ${Math.round(compressedFile.size / 1024)} KB</p>
                                    <img src="${url}" width="200"><hr>`;
          } catch (err) {
            outputDiv.innerHTML += `<p style="color:red;">‚ùå Gagal kompres gambar: ${err.message}</p>`;
            console.error('Image error:', err);
          }

        } else if (fileType.startsWith('video/')) {
          // KOMPREST VIDEO
          try {
            if (!ffmpeg.isLoaded()) {
              outputDiv.innerHTML += `<p>‚è≥ Loading video compressor...</p>`;
              await ffmpeg.load();
            }

            const inputFileName = file.name;
            const outputFileName = 'compressed.mp4';

            outputDiv.innerHTML += `<p>üì• Menulis video ke memori...</p>`;
            ffmpeg.FS('writeFile', inputFileName, await fetchFile(file));

            outputDiv.innerHTML += `<p>‚öôÔ∏è Kompresi video...</p>`;
            await ffmpeg.run('-i', inputFileName, '-vcodec', 'libx264', '-crf', '28', outputFileName);

            outputDiv.innerHTML += `<p>üì§ Mengambil hasil kompres...</p>`;
            const data = ffmpeg.FS('readFile', outputFileName);
            const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(videoBlob);

            outputDiv.innerHTML += `<p>‚úÖ Video dikompres: ${outputFileName} - ${Math.round(videoBlob.size / 1024)} KB</p>
                                    <video src="${url}" controls width="300"></video><hr>`;

            // Bersihkan
            ffmpeg.FS('unlink', inputFileName);
            ffmpeg.FS('unlink', outputFileName);
          } catch (err) {
            outputDiv.innerHTML += `<p style="color:red;">‚ùå Gagal kompres video: ${err.message}</p>`;
            console.error('Video error:', err);
          }
        } else {
          outputDiv.innerHTML += `<p style="color:orange;">‚ö†Ô∏è Tipe file tidak didukung: ${file.name}</p>`;
        }
      }

      outputDiv.innerHTML += `<p>‚úÖ Semua selesai.</p>`;
    });
  </script>
</body>
</html>
